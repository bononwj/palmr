# Palmr ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

## éƒ¨ç½²å‰æ£€æŸ¥ â˜‘ï¸

### 1. æœåŠ¡å™¨ç¯å¢ƒ

- [ ] Docker å·²å®‰è£… (ç‰ˆæœ¬ >= 19.03)
- [ ] Docker Compose å·²å®‰è£…
- [ ] æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆå»ºè®® >= 100GBï¼‰
- [ ] æœåŠ¡å™¨å†…å­˜å……è¶³ï¼ˆå»ºè®® >= 4GBï¼‰

### 2. SSL è¯ä¹¦

- [ ] è¯ä¹¦æ–‡ä»¶å­˜åœ¨ï¼š`/etc/nginx/cert/yipai360.com.pem`
- [ ] ç§é’¥æ–‡ä»¶å­˜åœ¨ï¼š`/etc/nginx/cert/yipai360.com.key`
- [ ] è¯ä¹¦æƒé™æ­£ç¡®ï¼š`chmod 644 *.pem && chmod 600 *.key`
- [ ] è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥ï¼ˆå»ºè®® > 30 å¤©ï¼‰
- [ ] è¯ä¹¦ä¸ç§é’¥åŒ¹é…éªŒè¯

éªŒè¯å‘½ä»¤ï¼š

```bash
ls -lh /etc/nginx/cert/
openssl x509 -in /etc/nginx/cert/yipai360.com.pem -noout -dates
```

### 3. åŸŸåå’Œç½‘ç»œ

- [ ] åŸŸåå·²è§£æï¼š`download.yipai360.com` â†’ æœåŠ¡å™¨ IP
- [ ] é˜²ç«å¢™å·²å¼€æ”¾ 80 ç«¯å£
- [ ] é˜²ç«å¢™å·²å¼€æ”¾ 443 ç«¯å£
- [ ] DNS è§£æç”Ÿæ•ˆç¡®è®¤

éªŒè¯å‘½ä»¤ï¼š

```bash
nslookup download.yipai360.com
netstat -tlnp | grep -E ":(80|443)"
```

### 4. é•œåƒä»“åº“è®¿é—®

- [ ] é˜¿é‡Œäº‘é•œåƒä»“åº“ç™»å½•æˆåŠŸ
- [ ] èƒ½å¤Ÿæ‹‰å–æœ€æ–°é•œåƒ

éªŒè¯å‘½ä»¤ï¼š

```bash
docker login cn-hz-acr-registry.cn-hangzhou.cr.aliyuncs.com
docker pull cn-hz-acr-registry.cn-hangzhou.cr.aliyuncs.com/yipai/palmr:latest
```

### 5. é¡¹ç›®æ–‡ä»¶

- [ ] `docker-compose-nginx.yaml` é…ç½®æ­£ç¡®
- [ ] `nginx/nginx.conf` å­˜åœ¨
- [ ] `nginx/conf.d/palmr.conf` é…ç½®æ­£ç¡®
- [ ] åŸŸåé…ç½®ï¼š`download.yipai360.com`
- [ ] SSL è¯ä¹¦è·¯å¾„é…ç½®ï¼š`/etc/nginx/cert/`

## éƒ¨ç½²æ‰§è¡Œ ğŸš€

### æ­¥éª¤ 1: å¯åŠ¨æœåŠ¡

```bash
make start-nginx
```

- [ ] å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] æ— é”™è¯¯è¾“å‡º

### æ­¥éª¤ 2: æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker ps
```

- [ ] `palmr-nginx` å®¹å™¨è¿è¡Œä¸­
- [ ] `palmr` å®¹å™¨è¿è¡Œä¸­
- [ ] ä¸¤ä¸ªå®¹å™¨çŠ¶æ€éƒ½æ˜¯ `Up`

### æ­¥éª¤ 3: æ£€æŸ¥æ—¥å¿—

```bash
docker-compose -f docker-compose-nginx.yaml logs
```

- [ ] Nginx å¯åŠ¨æˆåŠŸ
- [ ] Palmr å¯åŠ¨æˆåŠŸ
- [ ] æ— ä¸¥é‡é”™è¯¯ä¿¡æ¯

## åŠŸèƒ½éªŒè¯ âœ…

### 1. HTTP é‡å®šå‘æµ‹è¯•

```bash
curl -I http://download.yipai360.com
```

- [ ] è¿”å› `301 Moved Permanently`
- [ ] Location å¤´æŒ‡å‘ `https://download.yipai360.com`

### 2. HTTPS è®¿é—®æµ‹è¯•

```bash
curl -I https://download.yipai360.com
```

- [ ] è¿”å› `200 OK`
- [ ] SSL è¯ä¹¦éªŒè¯é€šè¿‡
- [ ] å“åº”å¤´åŒ…å« `Strict-Transport-Security`

### 3. æµè§ˆå™¨è®¿é—®æµ‹è¯•

è®¿é—®ï¼šhttps://download.yipai360.com

- [ ] é¡µé¢æ­£å¸¸åŠ è½½
- [ ] SSL è¯ä¹¦æ˜¾ç¤ºæœ‰æ•ˆï¼ˆç»¿è‰²é”å›¾æ ‡ï¼‰
- [ ] æ— è¯ä¹¦è­¦å‘Š
- [ ] é¡µé¢åŠŸèƒ½æ­£å¸¸

### 4. å¥åº·æ£€æŸ¥

```bash
curl https://download.yipai360.com/nginx-health
```

- [ ] è¿”å› `healthy`

### 5. API æµ‹è¯•

```bash
curl https://download.yipai360.com/api/
```

- [ ] API å“åº”æ­£å¸¸
- [ ] æ— é”™è¯¯ä¿¡æ¯

### 6. æ–‡ä»¶ä¸Šä¼ æµ‹è¯•

- [ ] å°æ–‡ä»¶ä¸Šä¼ æˆåŠŸ (< 100MB)
- [ ] å¤§æ–‡ä»¶ä¸Šä¼ æˆåŠŸ (> 1GB)
- [ ] ä¸Šä¼ è¿›åº¦æ­£å¸¸æ˜¾ç¤º

### 7. æ–‡ä»¶ä¸‹è½½æµ‹è¯•

- [ ] æ–‡ä»¶ä¸‹è½½æ­£å¸¸
- [ ] ä¸‹è½½é€Ÿåº¦æ­£å¸¸
- [ ] æ–­ç‚¹ç»­ä¼ åŠŸèƒ½æ­£å¸¸

## å®‰å…¨æ£€æŸ¥ ğŸ”’

### 1. SSL/TLS é…ç½®

```bash
# ä½¿ç”¨ SSL Labs æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
# è®¿é—®ï¼šhttps://www.ssllabs.com/ssltest/
```

- [ ] TLS 1.2 å’Œ 1.3 å¯ç”¨
- [ ] ä¸å®‰å…¨çš„ SSL 3.0 å’Œ TLS 1.0/1.1 ç¦ç”¨
- [ ] HSTS å¤´å·²é…ç½®
- [ ] HTTP/2 å·²å¯ç”¨

### 2. å®‰å…¨å¤´æ£€æŸ¥

```bash
curl -I https://download.yipai360.com
```

æ£€æŸ¥å“åº”å¤´ï¼š

- [ ] `Strict-Transport-Security` å­˜åœ¨
- [ ] æ— æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼ˆå¦‚ç‰ˆæœ¬å·ï¼‰

### 3. è®¿é—®æ§åˆ¶

- [ ] åªå…è®¸å¿…è¦çš„ç«¯å£è®¿é—®
- [ ] ä¸éœ€è¦çš„æœåŠ¡å·²ç¦ç”¨
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®æ­£ç¡®

## ç›‘æ§è®¾ç½® ğŸ“Š

### 1. æ—¥å¿—é…ç½®

- [ ] Nginx è®¿é—®æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] Nginx é”™è¯¯æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] Palmr åº”ç”¨æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] æ—¥å¿—è½®è½¬é…ç½®ï¼ˆå¯é€‰ï¼‰

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
make logs-nginx
docker logs -f palmr
```

### 2. å¥åº·ç›‘æ§

- [ ] é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬ï¼ˆå¯é€‰ï¼‰
- [ ] è®¾ç½®è¯ä¹¦è¿‡æœŸæé†’ï¼ˆå¯é€‰ï¼‰
- [ ] é…ç½®èµ„æºä½¿ç”¨ç›‘æ§ï¼ˆå¯é€‰ï¼‰

### 3. å‘Šè­¦é€šçŸ¥

- [ ] é…ç½®æ•…éšœå‘Šè­¦ï¼ˆå¯é€‰ï¼‰
- [ ] é…ç½®è¯ä¹¦è¿‡æœŸå‘Šè­¦ï¼ˆå¯é€‰ï¼‰

## æ€§èƒ½éªŒè¯ âš¡

### 1. å“åº”æ—¶é—´

```bash
time curl -I https://download.yipai360.com
```

- [ ] é¦–æ¬¡è®¿é—® < 2 ç§’
- [ ] åç»­è®¿é—® < 1 ç§’

### 2. å¹¶å‘æµ‹è¯•

```bash
# ä½¿ç”¨ ab æˆ– wrk è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
ab -n 1000 -c 10 https://download.yipai360.com/
```

- [ ] ç³»ç»Ÿç¨³å®šæ€§è‰¯å¥½
- [ ] æ— æ˜æ˜¾æ€§èƒ½ç“¶é¢ˆ

### 3. èµ„æºä½¿ç”¨

```bash
docker stats palmr palmr-nginx
```

- [ ] CPU ä½¿ç”¨ç‡æ­£å¸¸ (< 80%)
- [ ] å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸ (< 80%)
- [ ] æ— å†…å­˜æ³„æ¼è¿¹è±¡

## å¤‡ä»½å’Œæ¢å¤ ğŸ’¾

### 1. é…ç½®å¤‡ä»½

```bash
tar -czf palmr-config-backup-$(date +%Y%m%d).tar.gz \
  nginx/ docker-compose-nginx.yaml
```

- [ ] é…ç½®æ–‡ä»¶å·²å¤‡ä»½
- [ ] å¤‡ä»½æ–‡ä»¶å·²ä¿å­˜åˆ°å®‰å…¨ä½ç½®

### 2. æ•°æ®å¤‡ä»½

```bash
docker run --rm \
  -v palmr_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/palmr-data-$(date +%Y%m%d).tar.gz /data
```

- [ ] åº”ç”¨æ•°æ®å·²å¤‡ä»½
- [ ] å¤‡ä»½ç­–ç•¥å·²åˆ¶å®šï¼ˆå»ºè®®æ¯æ—¥å¤‡ä»½ï¼‰

### 3. æ¢å¤æµ‹è¯•

- [ ] å¤‡ä»½æ–‡ä»¶å¯ä»¥æ­£å¸¸è§£å‹
- [ ] æ¢å¤æµç¨‹å·²æ–‡æ¡£åŒ–
- [ ] æ¢å¤æµç¨‹å·²æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

## æ–‡æ¡£å’Œäº¤æ¥ ğŸ“

### 1. æ–‡æ¡£å‡†å¤‡

- [ ] éƒ¨ç½²æ–‡æ¡£å·²å®Œæˆ
- [ ] è¿ç»´æ‰‹å†Œå·²å‡†å¤‡
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—å·²å‡†å¤‡
- [ ] è”ç³»æ–¹å¼å·²æ›´æ–°

### 2. å›¢é˜Ÿäº¤æ¥

- [ ] ç›¸å…³äººå‘˜å·²åŸ¹è®­
- [ ] è®¿é—®æƒé™å·²åˆ†é…
- [ ] ç´§æ€¥è”ç³»æµç¨‹å·²å»ºç«‹

## éƒ¨ç½²åæ£€æŸ¥ ğŸ”

### ç¬¬ 1 å¤©

- [ ] ç›‘æ§æ‰€æœ‰æ—¥å¿—
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è®¿é—®
- [ ] éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

### ç¬¬ 1 å‘¨

- [ ] æ£€æŸ¥ç³»ç»Ÿç¨³å®šæ€§
- [ ] åˆ†æè®¿é—®æ—¥å¿—
- [ ] ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
- [ ] æ›´æ–°æ–‡æ¡£

### ç¬¬ 1 æœˆ

- [ ] æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
- [ ] æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
- [ ] è¯„ä¼°ç³»ç»Ÿæ€§èƒ½
- [ ] åˆ¶å®šç»´æŠ¤è®¡åˆ’

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ ğŸ“Œ

```bash
# å¯åŠ¨æœåŠ¡
make start-nginx

# åœæ­¢æœåŠ¡
make stop-nginx

# é‡å¯æœåŠ¡
make restart-nginx

# æŸ¥çœ‹æ—¥å¿—
make logs-nginx

# é‡è½½ Nginx é…ç½®
make reload-nginx

# æµ‹è¯• Nginx é…ç½®
make test-nginx

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# è¿›å…¥å®¹å™¨
make shell-nginx  # Nginx
make shell        # Palmr
```

## é—®é¢˜è”ç³» ğŸ“

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`make logs-nginx` å’Œ `docker logs palmr`
2. **æ£€æŸ¥é…ç½®**ï¼š`make test-nginx`
3. **éªŒè¯ç½‘ç»œ**ï¼šæ£€æŸ¥ç«¯å£å’Œé˜²ç«å¢™
4. **æ£€æŸ¥è¯ä¹¦**ï¼šéªŒè¯è¯ä¹¦æœ‰æ•ˆæœŸå’Œæƒé™
5. **é‡å¯æœåŠ¡**ï¼š`make restart-nginx`

## ç­¾ç½²ç¡®è®¤ âœï¸

éƒ¨ç½²å®Œæˆåï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

- **éƒ¨ç½²æ—¥æœŸ**: **\*\***\_\_\_**\*\***
- **éƒ¨ç½²äººå‘˜**: **\*\***\_\_\_**\*\***
- **éªŒè¯äººå‘˜**: **\*\***\_\_\_**\*\***
- **æ‰€æœ‰æ£€æŸ¥é¡¹å·²å®Œæˆ**: [ ] æ˜¯ / [ ] å¦
- **å¤‡æ³¨**: **\*\***\_\_\_**\*\***

---

**æç¤º**: å»ºè®®åœ¨éƒ¨ç½²å‰æ‰“å°æ­¤æ¸…å•ï¼Œé€é¡¹æ£€æŸ¥å¹¶è®°å½•ã€‚
